



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Documentation for the Nakama realtime and social server for games and apps.">
      
      
        <link rel="canonical" href="https://heroiclabs.com/tutorial-send-push-messages/">
      
      
        <meta name="author" content="Heroic Labs Team & contributors">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../images/favicon.ico">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.2.0">
    
    
      
        <title>Send push messages - Nakama server</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.5d3fffba.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.fbd935c7.css">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../stylesheets/code-tabs.css">
    
    
  </head>
  
    
    
    
      <body data-md-color-primary="indigo" data-md-color-accent="indigo">
    
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://heroiclabs.com/" title="Nakama server" class="md-header-nav__button md-logo">
          
            <img src="../images/logo-white.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Nakama server
              </span>
              <span class="md-header-nav__topic">
                Send push messages
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/heroiclabs/nakama/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      heroiclabs/nakama
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <img src="../images/logo-white.svg" width="24" height="24">
      
    </span>
    Nakama server
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/heroiclabs/nakama/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      heroiclabs/nakama
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../nakama-download/" title="Download" class="md-nav__link">
      Download
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Install and setup
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Install and setup
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../install-docker-quickstart/" title="Docker quickstart" class="md-nav__link">
      Docker quickstart
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install-binary/" title="Binary install" class="md-nav__link">
      Binary install
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install-configuration/" title="Configuration" class="md-nav__link">
      Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install-server-cli/" title="Nakama CLI" class="md-nav__link">
      Nakama CLI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install-nakama-upgrade/" title="Upgrades" class="md-nav__link">
      Upgrades
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../unity-client-guide/" title="Unity client guide" class="md-nav__link">
      Unity client guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../android-java-client-guide/" title="Android client guide" class="md-nav__link">
      Android client guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../javascript-client-guide/" title="JavaScript client guide" class="md-nav__link">
      JavaScript client guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../swift-ios-client-guide/" title="Swift/iOS client guide" class="md-nav__link">
      Swift/iOS client guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../authentication/" title="Authentication" class="md-nav__link">
      Authentication
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../user-accounts/" title="User accounts" class="md-nav__link">
      User accounts
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Storage Engine
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        Storage Engine
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../storage-collections/" title="Collections" class="md-nav__link">
      Collections
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11">
    
    <label class="md-nav__link" for="nav-11">
      Social
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        Social
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../social-friends/" title="Friends" class="md-nav__link">
      Friends
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../social-groups-clans/" title="Groups and Clans" class="md-nav__link">
      Groups and Clans
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../social-in-app-notifications/" title="In-app Notifications" class="md-nav__link">
      In-app Notifications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../social-realtime-chat/" title="Realtime Chat" class="md-nav__link">
      Realtime Chat
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-12" type="checkbox" id="nav-12">
    
    <label class="md-nav__link" for="nav-12">
      Gameplay
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-12">
        Gameplay
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../gameplay-leaderboards/" title="Leaderboards" class="md-nav__link">
      Leaderboards
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../gameplay-matchmaker/" title="Matchmaker" class="md-nav__link">
      Matchmaker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../gameplay-multiplayer-realtime/" title="Realtime Multiplayer" class="md-nav__link">
      Realtime Multiplayer
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../in-app-purchase-validation/" title="In-app Purchase Validation" class="md-nav__link">
      In-app Purchase Validation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-14" type="checkbox" id="nav-14">
    
    <label class="md-nav__link" for="nav-14">
      Runtime Code
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-14">
        Runtime Code
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../runtime-code-basics/" title="Basics" class="md-nav__link">
      Basics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../runtime-code-function-reference/" title="Function Reference" class="md-nav__link">
      Function Reference
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../benchmarks/" title="Benchmarks" class="md-nav__link">
      Benchmarks
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-16" type="checkbox" id="nav-16">
    
    <label class="md-nav__link" for="nav-16">
      Deployment
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-16">
        Deployment
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../deployment-digital-ocean/" title="Digital Ocean" class="md-nav__link">
      Digital Ocean
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-17" type="checkbox" id="nav-17" checked>
    
    <label class="md-nav__link" for="nav-17">
      Tutorials
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-17">
        Tutorials
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../tutorial-develop-with-libgdx/" title="Develop with LibGDX" class="md-nav__link">
      Develop with LibGDX
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tutorial-initialize-new-user/" title="Initialize a new user" class="md-nav__link">
      Initialize a new user
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tutorial-remote-configuration/" title="Remote configuration" class="md-nav__link">
      Remote configuration
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Send push messages
      </label>
    
    <a href="./" title="Send push messages" class="md-nav__link md-nav__link--active">
      Send push messages
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" title="Setup" class="md-nav__link">
    Setup
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#keys-and-credentials" title="Keys and credentials" class="md-nav__link">
    Keys and credentials
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#register-a-users-device" title="Register a user's device" class="md-nav__link">
    Register a user's device
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#send-a-push-message" title="Send a push message" class="md-nav__link">
    Send a push message
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#send-to-segments" title="Send to Segments" class="md-nav__link">
    Send to Segments
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#send-via-filters" title="Send via Filters" class="md-nav__link">
    Send via Filters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#send-to-devices" title="Send to Devices" class="md-nav__link">
    Send to Devices
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notes" title="Notes" class="md-nav__link">
    Notes
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" title="Setup" class="md-nav__link">
    Setup
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#keys-and-credentials" title="Keys and credentials" class="md-nav__link">
    Keys and credentials
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#register-a-users-device" title="Register a user's device" class="md-nav__link">
    Register a user's device
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#send-a-push-message" title="Send a push message" class="md-nav__link">
    Send a push message
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#send-to-segments" title="Send to Segments" class="md-nav__link">
    Send to Segments
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#send-via-filters" title="Send via Filters" class="md-nav__link">
    Send via Filters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#send-to-devices" title="Send to Devices" class="md-nav__link">
    Send to Devices
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notes" title="Notes" class="md-nav__link">
    Notes
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/heroiclabs/nakama/edit/master/docs/tutorial-send-push-messages.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="send-push-messages">Send push messages<a class="headerlink" href="#send-push-messages" title="Permanent link">&para;</a></h1>
<p>Push messages are a great complement to <a href="../social-in-app-notifications/">in-app notifications</a> in Nakama. You can use in-app notifications for when a user is online but for when the app is closed or backgrounded and you want to bring the user back or re-engage push messages are a great option.</p>
<p>There are many different push providers available which you can integrate into your client code and combine it with the server but for this tutorial we'll use the One Signal service. They provide a HTTP API to register devices and send push messages to segments of users.</p>
<h2 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">&para;</a></h2>
<p>We can easily write a Lua module which provides the One Signal HTTP API as a set of functions which can be imported into other code but instead we'll import one written by the Heroic Labs team and maintained with the community. You can find the code in the <a href="https://github.com/heroiclabs/nakama-modules" target="\_blank">official repository</a> of modules.</p>
<p><a href="https://github.com/heroiclabs/nakama-modules/blob/master/modules/onesignal.lua">https://github.com/heroiclabs/nakama-modules/blob/master/modules/onesignal.lua</a></p>
<p>Download and add the "onesignal.lua" file to the location you use for your Lua modules. You can put the files into whatever folder you like and specify the location when you run the server.</p>
<div class="codehilite"><pre><span></span>nakama --log.stdout --runtime.path &quot;/some/path/dir/&quot;
</pre></div>


<p>When you server is started you'll see the One Signal module loaded and recorded in the startup logs. In development it can be helpful to run the server with "--log.stdout" for log output in the console.</p>
<h3 id="keys-and-credentials">Keys and credentials<a class="headerlink" href="#keys-and-credentials" title="Permanent link">&para;</a></h3>
<p>With the module added we can import it into our own Lua module. Let's create a module called "pmessage.lua" which will handle all our usage with One Signal in this tutorial project.</p>
<p>The One Signal API requires both an API Key and an App Id be used to authenticate and communicate with their servers. You can find these credentials in their dashboard. Replace "someapikey" and "someappid" with your strings.</p>
<div class="codehilite"><pre><span></span><span class="kd">local</span> <span class="n">ONESIGNAL_API_KEY</span> <span class="o">=</span> <span class="s2">&quot;someapikey&quot;</span>
<span class="kd">local</span> <span class="n">ONESIGNAL_APP_ID</span> <span class="o">=</span> <span class="s2">&quot;someappid&quot;</span>

<span class="kd">local</span> <span class="n">onesignal</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;onesignal&quot;</span><span class="p">).</span><span class="n">new</span><span class="p">(</span><span class="n">ONESIGNAL_API_KEY</span><span class="p">,</span> <span class="n">ONESIGNAL_APP_ID</span><span class="p">)</span>
</pre></div>


<h2 id="register-a-users-device">Register a user's device<a class="headerlink" href="#register-a-users-device" title="Permanent link">&para;</a></h2>
<p>Before push messages can be sent to devices they must be registered with the One Signal service.</p>
<p>A device identifier which must be obtained through Android/iOS/etc APIs on the handset provide a unique string used to identify the device when push messages are sent out. This identifier is used to create the device in One Signal.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The REST API for One Signal does not recommend you <a href="https://documentation.onesignal.com/v3.0/reference#add-a-device" target="\_blank">register a device</a> on the server. The Lua module implements all functions available in the API for completeness but when registering devices it may be best to use their SDK.</p>
</div>
<div class="codehilite"><pre><span></span><span class="cm">--[[</span>
<span class="cm">  &quot;device_type&quot; can be one of:</span>
<span class="cm">  0 - ios</span>
<span class="cm">  1 - android</span>
<span class="cm">  2 - amazon</span>
<span class="cm">  3 - windowsphone</span>
<span class="cm">  ... etc.</span>
<span class="cm">]]</span>
<span class="kd">local</span> <span class="n">device_type</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">-- &quot;identifier&quot; is the push identifier which must be sent from the client</span>
<span class="kd">local</span> <span class="n">identifier</span> <span class="o">=</span> <span class="s2">&quot;platformspecificdeviceidentifier&quot;</span>
<span class="kd">local</span> <span class="n">language</span> <span class="o">=</span> <span class="s2">&quot;en&quot;</span>
<span class="kd">local</span> <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
  <span class="n">foo</span> <span class="o">=</span> <span class="s2">&quot;bar&quot;</span>
<span class="p">}</span>
<span class="n">onesignal</span><span class="p">:</span><span class="n">add_device</span><span class="p">(</span><span class="n">device_type</span><span class="p">,</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">language</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
</pre></div>


<p>We'll register an RPC hook which can be called via clients and receives the device identifier as a JSON payload.</p>
<div class="codehilite"><pre><span></span><span class="kd">local</span> <span class="n">nk</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;nakama&quot;</span><span class="p">)</span>

<span class="cm">--[[</span>
<span class="cm">  The payload input is expected to be structured as JSON:</span>
<span class="cm">  { &quot;DeviceType&quot;: 1, &quot;Identifier&quot;: &quot;somevalue&quot; }</span>
<span class="cm">]]</span><span class="c1">--</span>
<span class="kd">local</span> <span class="kr">function</span> <span class="nf">register_push</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">json</span> <span class="o">=</span> <span class="n">nk</span><span class="p">.</span><span class="n">json_decode</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

  <span class="kd">local</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">DeviceType</span>
  <span class="kd">local</span> <span class="n">id</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">Identifier</span>
  <span class="kd">local</span> <span class="n">success</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">pcall</span><span class="p">(</span><span class="n">onesignal</span><span class="p">:</span><span class="n">add_device</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="s2">&quot;en&quot;</span><span class="p">,</span> <span class="p">{})</span>
  <span class="kr">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="kr">then</span>
    <span class="c1">-- store the push &quot;player id&quot; from One Signal in the current user metadata</span>
    <span class="kd">local</span> <span class="n">user_updates</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">{</span> <span class="n">UserId</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">UserId</span><span class="p">,</span> <span class="n">Metadata</span> <span class="o">=</span> <span class="p">{</span> <span class="n">os_player_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">id</span> <span class="p">}</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">pcall</span><span class="p">(</span><span class="n">nk</span><span class="p">.</span><span class="n">users_update</span><span class="p">,</span> <span class="n">user_updates</span><span class="p">)</span> <span class="c1">-- ignore errors</span>
  <span class="kr">end</span>
<span class="kr">end</span>

<span class="n">nk</span><span class="p">.</span><span class="n">register_rpc</span><span class="p">(</span><span class="n">register_push</span><span class="p">,</span> <span class="s2">&quot;register_push&quot;</span><span class="p">)</span>
</pre></div>


<p>In your project you can now send a JSON encoded RPC message from a client with a device identifier and trigger the RPC function which will register the device with the service. Have a look at the <a href="../runtime-code-basics/#an-example-module">example</a> of a client RPC message which sends JSON.</p>
<h2 id="send-a-push-message">Send a push message<a class="headerlink" href="#send-a-push-message" title="Permanent link">&para;</a></h2>
<p>There's multiple ways to send push messages via One Signal. Messages can be queued and sent in the dashboard but can also be sent programmatically via the REST API.</p>
<h3 id="send-to-segments">Send to Segments<a class="headerlink" href="#send-to-segments" title="Permanent link">&para;</a></h3>
<p>A segment is a group of devices which are grouped together within the One Signal service. Segments have names which are used to determine which devices receive or are excluded from receiving a push message.</p>
<p>It'll be most common to send push messages to segments via the One Signal dashboard but it can also be done via Lua.</p>
<div class="codehilite"><pre><span></span><span class="kd">local</span> <span class="n">contents</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">en</span> <span class="o">=</span> <span class="s2">&quot;English message&quot;</span>
<span class="p">}</span>
<span class="kd">local</span> <span class="n">headings</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">en</span> <span class="o">=</span> <span class="s2">&quot;English title&quot;</span>
<span class="p">}</span>
<span class="kd">local</span> <span class="n">included_segments</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;All&quot;</span> <span class="p">}</span>
<span class="kd">local</span> <span class="n">filters</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="kd">local</span> <span class="n">player_ids</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="kd">local</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">excluded_segments</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;Banned&quot;</span> <span class="p">}</span>
<span class="p">}</span>
<span class="n">onesignal</span><span class="p">:</span><span class="n">create_notification</span><span class="p">(</span>
    <span class="n">contents</span><span class="p">,</span> <span class="n">headings</span><span class="p">,</span> <span class="n">included_segments</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">player_ids</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</pre></div>


<h3 id="send-via-filters">Send via Filters<a class="headerlink" href="#send-via-filters" title="Permanent link">&para;</a></h3>
<p>Filters are used to specify included or excluded devices based on information within the service about a user or tags attached to their device. Filters can be used to send <a href="https://documentation.onesignal.com/v3.0/reference#section-send-to-users-based-on-filters" target="\_blank">highly targeted</a> push messages to devices.</p>
<div class="codehilite"><pre><span></span><span class="kd">local</span> <span class="n">contents</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">en</span> <span class="o">=</span> <span class="s2">&quot;English message&quot;</span>
<span class="p">}</span>
<span class="kd">local</span> <span class="n">headings</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">en</span> <span class="o">=</span> <span class="s2">&quot;English title&quot;</span>
<span class="p">}</span>
<span class="kd">local</span> <span class="n">included_segments</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="kd">local</span> <span class="n">filters</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span> <span class="n">field</span> <span class="o">=</span> <span class="s2">&quot;tag&quot;</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="n">relation</span> <span class="o">=</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;10&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">field</span> <span class="o">=</span> <span class="s2">&quot;amount_spent&quot;</span><span class="p">,</span> <span class="n">relation</span> <span class="o">=</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="p">}</span>
<span class="p">}</span>
<span class="kd">local</span> <span class="n">player_ids</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="kd">local</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">onesignal</span><span class="p">:</span><span class="n">create_notification</span><span class="p">(</span>
    <span class="n">contents</span><span class="p">,</span> <span class="n">headings</span><span class="p">,</span> <span class="n">included_segments</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">player_ids</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</pre></div>


<h3 id="send-to-devices">Send to Devices<a class="headerlink" href="#send-to-devices" title="Permanent link">&para;</a></h3>
<p>Push messages can be sent to targeted devices with the identifier "player_id" which is returned when a device is added to the One Signal service. This is the most common use case of the One Signal module in a project.</p>
<p>As an example we'll retrieve the One Signal push identifier "os_player_id" which was stored for a user in their metadata with the <a href="#register-a-users-device">RPC code</a> and create a notification which will be sent to those users.</p>
<div class="codehilite"><pre><span></span><span class="kd">local</span> <span class="n">player_ids</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kd">local</span> <span class="n">user_ids</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;3ea5608a-43c3-11e7-90f9-7b9397165f34&quot;</span><span class="p">,</span>
  <span class="s2">&quot;447524be-43c3-11e7-af09-3f7172f05936&quot;</span>
<span class="p">}</span>
<span class="kd">local</span> <span class="n">users</span> <span class="o">=</span> <span class="n">nk</span><span class="p">.</span><span class="n">users_fetch_id</span><span class="p">(</span><span class="n">user_ids</span><span class="p">)</span>
<span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">u</span> <span class="kr">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
<span class="kr">do</span>
  <span class="c1">-- get the onesignal id for each user</span>
  <span class="nb">table.insert</span><span class="p">(</span><span class="n">player_ids</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">Metadata</span><span class="p">.</span><span class="n">os_player_id</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kd">local</span> <span class="n">contents</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">en</span> <span class="o">=</span> <span class="s2">&quot;English message&quot;</span>
<span class="p">}</span>
<span class="kd">local</span> <span class="n">headings</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">en</span> <span class="o">=</span> <span class="s2">&quot;English title&quot;</span>
<span class="p">}</span>
<span class="kd">local</span> <span class="n">included_segments</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="kd">local</span> <span class="n">filters</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="kd">local</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">onesignal</span><span class="p">:</span><span class="n">create_notification</span><span class="p">(</span>
    <span class="n">contents</span><span class="p">,</span> <span class="n">headings</span><span class="p">,</span> <span class="n">included_segments</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">player_ids</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</pre></div>


<h2 id="notes">Notes<a class="headerlink" href="#notes" title="Permanent link">&para;</a></h2>
<p>The official One Signal module may be updated occasionally to reflect changes in the REST API. You can subscribe to watch the <a href="https://github.com/heroiclabs/nakama-modules">nakama-modules</a> code for updates.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../tutorial-remote-configuration/" title="Remote configuration" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Remote configuration
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2017 Heroic Labs
          </div>
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://heroiclabs.com" class="md-footer-social__link fa fa-globe"></a>
    
      <a href="https://github.com/heroiclabs" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/heroicdev" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/company/heroic-labs" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.6cdc17f0.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:".."}})</script>
      
        <script src="../javascripts/main.js"></script>
      
    
    
      
    
  </body>
</html>