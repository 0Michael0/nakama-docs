
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Documentation for the Nakama realtime and social server for games and apps.">
      
      
        <link rel="canonical" href="https://heroiclabs.com/docs/unity-client-guide/">
      
      
        <meta name="author" content="Heroic Labs Team & contributors">
      
      
        <link rel="shortcut icon" href="../images/favicon.ico">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.7.4">
    
    
      
        <title>Unity client guide - Nakama server</title>
      
    
    
      <script src="../assets/javascripts/modernizr-1df76c4e58.js"></script>
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application-769c285a91.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-02c2a4388f.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="https://heroiclabs.com/docs/" title="Nakama server" class="md-logo md-header-nav__button">
            <img src="../images/logo-white.svg" width="24" height="24">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
            
            Unity client guide
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">close</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/heroiclabs/nakama" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      heroiclabs/nakama
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-logo md-nav__button">
        <img src="../images/logo-white.svg">
      </i>
    
    Nakama server
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/heroiclabs/nakama" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      heroiclabs/nakama
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Install and setup
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Install and setup
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../install-docker-quickstart/" title="Docker quickstart" class="md-nav__link">
      Docker quickstart
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install-binary/" title="Binary install" class="md-nav__link">
      Binary install
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install-configuration/" title="Configuration" class="md-nav__link">
      Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install-server-cli/" title="Nakama CLI" class="md-nav__link">
      Nakama CLI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install-nakama-upgrade/" title="Upgrades" class="md-nav__link">
      Upgrades
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Unity client guide
      </label>
    
    <a href="./" title="Unity client guide" class="md-nav__link md-nav__link--active">
      Unity client guide
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#download" title="Download" class="md-nav__link">
    Download
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-and-setup" title="Install and setup" class="md-nav__link">
    Install and setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authenticate" title="Authenticate" class="md-nav__link">
    Authenticate
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#send-messages" title="Send messages" class="md-nav__link">
    Send messages
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handle-events" title="Handle events" class="md-nav__link">
    Handle events
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main-thread-dispatch" title="Main thread dispatch" class="md-nav__link">
    Main thread dispatch
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#managed-client" title="Managed client" class="md-nav__link">
    Managed client
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logs-and-errors" title="Logs and errors" class="md-nav__link">
    Logs and errors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#full-example" title="Full example" class="md-nav__link">
    Full example
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../android-java-client-guide/" title="Android client guide" class="md-nav__link">
      Android client guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../javascript-client-guide/" title="JavaScript client guide" class="md-nav__link">
      JavaScript client guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../swift-ios-client-guide/" title="Swift/iOS client guide" class="md-nav__link">
      Swift/iOS client guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../authentication/" title="Authentication" class="md-nav__link">
      Authentication
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../user-accounts/" title="User accounts" class="md-nav__link">
      User accounts
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Storage Engine
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Storage Engine
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../storage-collections/" title="Collections" class="md-nav__link">
      Collections
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Social
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        Social
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../social-friends/" title="Friends" class="md-nav__link">
      Friends
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../social-groups-clans/" title="Groups and Clans" class="md-nav__link">
      Groups and Clans
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../social-in-app-notifications/" title="In-app Notifications" class="md-nav__link">
      In-app Notifications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../social-realtime-chat/" title="Realtime Chat" class="md-nav__link">
      Realtime Chat
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11">
    
    <label class="md-nav__link" for="nav-11">
      Gameplay
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        Gameplay
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../gameplay-leaderboards/" title="Leaderboards" class="md-nav__link">
      Leaderboards
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../gameplay-matchmaker/" title="Matchmaker" class="md-nav__link">
      Matchmaker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../gameplay-multiplayer-realtime/" title="Realtime Multiplayer" class="md-nav__link">
      Realtime Multiplayer
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../in-app-purchase-validation/" title="In-app Purchase Validation" class="md-nav__link">
      In-app Purchase Validation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-13" type="checkbox" id="nav-13">
    
    <label class="md-nav__link" for="nav-13">
      Runtime Code
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-13">
        Runtime Code
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../runtime-code-basics/" title="Basics" class="md-nav__link">
      Basics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../runtime-code-function-reference/" title="Function Reference" class="md-nav__link">
      Function Reference
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-14" type="checkbox" id="nav-14">
    
    <label class="md-nav__link" for="nav-14">
      Deployment
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-14">
        Deployment
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../deployment-digital-ocean/" title="Digital Ocean" class="md-nav__link">
      Digital Ocean
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-15" type="checkbox" id="nav-15">
    
    <label class="md-nav__link" for="nav-15">
      Tutorials
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-15">
        Tutorials
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../tutorial-develop-with-libgdx/" title="Develop with LibGDX" class="md-nav__link">
      Develop with LibGDX
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tutorial-initialize-new-user/" title="Initialize a new user" class="md-nav__link">
      Initialize a new user
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tutorial-remote-configuration/" title="Remote configuration" class="md-nav__link">
      Remote configuration
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#download" title="Download" class="md-nav__link">
    Download
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-and-setup" title="Install and setup" class="md-nav__link">
    Install and setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authenticate" title="Authenticate" class="md-nav__link">
    Authenticate
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#send-messages" title="Send messages" class="md-nav__link">
    Send messages
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handle-events" title="Handle events" class="md-nav__link">
    Handle events
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main-thread-dispatch" title="Main thread dispatch" class="md-nav__link">
    Main thread dispatch
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#managed-client" title="Managed client" class="md-nav__link">
    Managed client
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logs-and-errors" title="Logs and errors" class="md-nav__link">
    Logs and errors
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#full-example" title="Full example" class="md-nav__link">
    Full example
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="unity-client-guide">Unity client guide<a class="headerlink" href="#unity-client-guide" title="Permanent link">&para;</a></h1>
<p>The official Unity client handles all communication in realtime with the server. It implements all features in the server and is compatible with Unity 5.4+. To work with our Unity client you'll need to install and setup <a href="https://unity3d.com/get-unity/download">Unity engine</a>.</p>
<h2 id="download">Download<a class="headerlink" href="#download" title="Permanent link">&para;</a></h2>
<p>The client is available on the <a href="https://www.assetstore.unity3d.com/en/#!/content/81338" target="\_blank">Unity Asset store</a> and also on <a href="https://github.com/heroiclabs/nakama-unity/releases/latest" target="\_blank">GitHub releases</a>. You can download "Nakama.unitypackage" which contains all source code and DLL dependencies required in the client code.</p>
<p>For upgrades you can see changes and enhancements in the <a href="https://github.com/heroiclabs/nakama-unity/blob/master/CHANGELOG.md" target="\_blank">CHANGELOG</a> before you update to newer versions.</p>
<div class="admonition bug">
<p class="admonition-title">Help and contribute</p>
<p>The Unity client is <a href="https://github.com/heroiclabs/nakama-unity" target="\_blank">open source on GitHub</a>. Please report issues and contribute code to help us improve it.</p>
</div>
<h2 id="install-and-setup">Install and setup<a class="headerlink" href="#install-and-setup" title="Permanent link">&para;</a></h2>
<p>When you've <a href="#download">downloaded</a> the "Nakama.unitypackage" file you should drag or import it into your Unity editor project to install it. In the editor create a new C# script via the Assets menu with "Assets &gt; Create &gt; C# Script" and create an <code>INClient</code>.</p>
<p>The client object is used to execute all logic against the server.</p>
<div class="codehilite"><pre><span></span><span class="k">using</span> <span class="nn">Nakama</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">NakamaSessionManager</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
  <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">INClient</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NClient</span><span class="p">.</span><span class="n">Builder</span><span class="p">(</span><span class="s">&quot;defaultkey&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="n">Host</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="n">Port</span><span class="p">(</span><span class="m">7350</span><span class="p">)</span>
        <span class="p">.</span><span class="n">SSL</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
        <span class="p">.</span><span class="n">Build</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>We use the builder pattern with many classes in the Unity client. Most classes have a <code>".Default()"</code> method to construct an object with default values.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By default the client uses connection settings "127.0.0.1" and 7350 to connect to a local Nakama server.</p>
</div>
<div class="codehilite"><pre><span></span><span class="c1">// Quickly setup a client for a local server.</span>
<span class="n">INClient</span> <span class="n">client</span> <span class="p">=</span> <span class="n">NClient</span><span class="p">.</span><span class="n">Default</span><span class="p">(</span><span class="s">&quot;defaultkey&quot;</span><span class="p">);</span>
</pre></div>


<p>Unity uses an entity component system (ECS) which makes it simple to share the client across game objects. Have a read of <a href="https://docs.unity3d.com/Manual/ControllingGameObjectsComponents.html" target="\_blank">Controlling GameObjects Using Components</a> for examples on how to share a C# object across your game objects.</p>
<h2 id="authenticate">Authenticate<a class="headerlink" href="#authenticate" title="Permanent link">&para;</a></h2>
<p>With a client object you can authenticate against the server. You can register or login a <a href="../user-accounts/">user</a> with one of the <a href="../authentication/">authenticate options</a>.</p>
<p>To authenticate you should follow our recommended pattern in your client code:</p>
<p>&nbsp;&nbsp; 1. Build an instance of the client.</p>
<div class="codehilite"><pre><span></span><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="n">NClient</span><span class="p">.</span><span class="n">Default</span><span class="p">(</span><span class="s">&quot;defaultkey&quot;</span><span class="p">);</span>
</pre></div>


<p>&nbsp;&nbsp; 2. Write a callback which will be used to connect to the server.</p>
<div class="codehilite"><pre><span></span><span class="n">Action</span><span class="p">&lt;</span><span class="n">INSession</span><span class="p">&gt;</span> <span class="n">sessionHandler</span> <span class="p">=</span> <span class="k">delegate</span><span class="p">(</span><span class="n">INSession</span> <span class="n">session</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Debug</span><span class="p">.</span><span class="n">LogFormat</span><span class="p">(</span><span class="s">&quot;Session: &#39;{0}&#39;.&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>
  <span class="n">client</span><span class="p">.</span><span class="n">Connect</span><span class="p">(</span><span class="n">_session</span><span class="p">,</span> <span class="p">(</span><span class="kt">bool</span> <span class="n">done</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Session connected.&quot;</span><span class="p">);</span>
    <span class="c1">// Store session for quick reconnects.</span>
    <span class="n">PlayerPrefs</span><span class="p">.</span><span class="n">SetString</span><span class="p">(</span><span class="s">&quot;nk.session&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>
</pre></div>


<p>&nbsp;&nbsp; 3. Restore a session for quick reconnects.</p>
<div class="codehilite"><pre><span></span><span class="kt">var</span> <span class="n">sessionString</span> <span class="p">=</span> <span class="n">PlayerPrefs</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">&quot;nk.session&quot;</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">sessionString</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">INSession</span> <span class="n">session</span> <span class="p">=</span> <span class="n">NSession</span><span class="p">.</span><span class="n">Restore</span><span class="p">(</span><span class="n">sessionString</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(!</span><span class="n">session</span><span class="p">.</span><span class="n">HasExpired</span><span class="p">(</span><span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">sessionHandler</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>&nbsp;&nbsp; 4. Login or register a user.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>It's good practice to cache a device identifier when it's used to authenticate because they can change with device OS updates.</p>
</div>
<div class="codehilite"><pre><span></span><span class="n">Action</span><span class="p">&lt;</span><span class="n">INError</span><span class="p">&gt;</span> <span class="n">errorHandler</span> <span class="p">=</span> <span class="k">delegate</span><span class="p">(</span><span class="n">INError</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Debug</span><span class="p">.</span><span class="n">LogErrorFormat</span><span class="p">(</span><span class="s">&quot;Error: code &#39;{0}&#39; with &#39;{1}&#39;.&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="n">Code</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
<span class="p">};</span>

<span class="c1">// See if we have a cached id in PlayerPrefs.</span>
<span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="n">PlayerPrefs</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">&quot;nk.id&quot;</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
  <span class="c1">// We&#39;ll use device ID for the user. See other authentication options.</span>
  <span class="n">id</span> <span class="p">=</span> <span class="n">SystemInfo</span><span class="p">.</span><span class="n">deviceUniqueIdentifier</span><span class="p">;</span>
  <span class="c1">// Store the identifier for next game start.</span>
  <span class="n">PlayerPrefs</span><span class="p">.</span><span class="n">SetString</span><span class="p">(</span><span class="s">&quot;nk.id&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="n">NAuthenticateMessage</span><span class="p">.</span><span class="n">Device</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="n">_client</span><span class="p">.</span><span class="n">Login</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">SessionHandler</span><span class="p">,</span> <span class="p">(</span><span class="n">INError</span> <span class="n">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">.</span><span class="n">Code</span> <span class="p">==</span> <span class="n">ErrorCode</span><span class="p">.</span><span class="n">UserNotFound</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_client</span><span class="p">.</span><span class="n">Register</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">SessionHandler</span><span class="p">,</span> <span class="n">ErrorHandler</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">ErrorHandler</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>


<p>In the code above we use <code>NAuthenticateMessage.Device(id)</code> but for other authentication options have a look at the <a href="../authentication/#register-or-login">code examples</a>.</p>
<p>A <strong>full example</strong> class with all code above is <a href="#full-example">here</a>.</p>
<h2 id="send-messages">Send messages<a class="headerlink" href="#send-messages" title="Permanent link">&para;</a></h2>
<p>When a user has been authenticated a session is used to connect with the server. You can then send messages for all the different features in the server.</p>
<p>This could be to <a href="../social-friends/">add friends</a>, join <a href="../social-groups-clans/">groups</a> and <a href="../social-realtime-chat/">chat</a>, or submit scores in <a href="../gameplay-leaderboards/">leaderboards</a>, and <a href="../gameplay-matchmaker/">matchmake</a> into a <a href="../gameplay-multiplayer-realtime/">multiplayer match</a>. You can also execute remote code on the server via <a href="../runtime-code-basics/">RPC</a>.</p>
<p>The server also provides a <a href="../storage-collections/">storage engine</a> to keep save games and other records owned by users. We'll use storage to introduce how messages are sent.</p>
<div class="codehilite"><pre><span></span><span class="kt">byte</span><span class="p">[]</span> <span class="n">json</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="s">&quot;{\&quot;jsonkey\&quot;:\&quot;jsonvalue\&quot;}&quot;</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NStorageWriteMessage</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&quot;someBucket&quot;</span><span class="p">,</span> <span class="s">&quot;someCollection&quot;</span><span class="p">,</span> <span class="s">&quot;myRecord&quot;</span><span class="p">,</span> <span class="n">storageValue</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Build</span><span class="p">();</span>
<span class="n">client</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="p">(</span><span class="n">INResultSet</span><span class="p">&lt;</span><span class="n">INStorageKey</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Successfully wrote record.&quot;</span><span class="p">);</span>
<span class="p">},</span> <span class="p">(</span><span class="n">INError</span> <span class="n">error</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="n">Debug</span><span class="p">.</span><span class="n">LogErrorFormat</span><span class="p">(</span><span class="s">&quot;Error: code &#39;{0}&#39; with &#39;{1}&#39;.&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="n">Code</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>


<p>Have a look at other sections of documentation for more code examples.</p>
<h2 id="handle-events">Handle events<a class="headerlink" href="#handle-events" title="Permanent link">&para;</a></h2>
<p>The client has callbacks which are called on various events received from the server.</p>
<div class="codehilite"><pre><span></span><span class="n">client</span><span class="p">.</span><span class="n">OnError</span> <span class="p">=</span> <span class="p">(</span><span class="n">INError</span> <span class="n">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="n">Debug</span><span class="p">.</span><span class="n">LogErrorFormat</span><span class="p">(</span><span class="s">&quot;Error: code &#39;{0}&#39; with &#39;{1}&#39;.&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="n">Code</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
<span class="p">};</span>

<span class="n">client</span><span class="p">.</span><span class="n">OnDisconnect</span> <span class="p">=</span> <span class="p">(</span><span class="n">INDisconnectEvent</span> <span class="n">evt</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Disconnected from server.&quot;</span><span class="p">);</span>
  <span class="n">Debug</span><span class="p">.</span><span class="n">LogFormat</span><span class="p">(</span><span class="s">&quot;Reason &#39;{0}&#39;&quot;</span><span class="p">,</span> <span class="n">evt</span><span class="p">.</span><span class="n">Reason</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>Some events only need to be implemented for the features you want to use.</p>
<table>
<thead>
<tr>
<th>Callbacks</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>OnDisconnect</td>
<td>Handles an event for when the client is disconnected from the server.</td>
</tr>
<tr>
<td>OnError</td>
<td>Receives events about server errors.</td>
</tr>
<tr>
<td>OnMatchData</td>
<td>Handles <a href="../gameplay-multiplayer-realtime/">realtime match</a> messages.</td>
</tr>
<tr>
<td>OnMatchmakeMatched</td>
<td>Receives events when the <a href="../gameplay-matchmaker/">matchmaker</a> has found match participants.</td>
</tr>
<tr>
<td>OnMatchPresence</td>
<td>When in a <a href="../gameplay-multiplayer-realtime/">realtime match</a> receives events for when users join or leave.</td>
</tr>
<tr>
<td>OnNotification</td>
<td>Receives live <a href="../social-in-app-notifications/">in-app notifications</a> sent from the server.</td>
</tr>
<tr>
<td>OnTopicMessage</td>
<td>Receives <a href="../social-realtime-chat/">realtime chat</a> messages sent by other users.</td>
</tr>
<tr>
<td>OnTopicPresence</td>
<td>Similar to "OnMatchPresence" it handles join and leave events but within <a href="../social-realtime-chat/">chat</a>.</td>
</tr>
</tbody>
</table>
<h2 id="main-thread-dispatch">Main thread dispatch<a class="headerlink" href="#main-thread-dispatch" title="Permanent link">&para;</a></h2>
<p>The client runs all callbacks on a socket thread separate to the Unity main thread.</p>
<p>Unity engine does not let code which executes on another thread call one of it's APIs because of how it manages code execution within the game loop. This can causes errors which look something like "&lt;SomeMethod> can only be called from the main thread".</p>
<p>We recommend a simple pattern which can be used to run any code which calls <code>UnityEngine</code> APIs.</p>
<p>&nbsp;&nbsp; 1. Add a queue to your script which manages a client.</p>
<div class="codehilite"><pre><span></span><span class="n">Queue</span><span class="p">&lt;</span><span class="n">Action</span><span class="p">&gt;</span> <span class="n">executionQueue</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">Action</span><span class="p">&gt;(</span><span class="m">1024</span><span class="p">);</span>
</pre></div>


<p>&nbsp;&nbsp; 2. Add code in your <code>Update</code> method so the queued actions are run.</p>
<div class="codehilite"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">l</span> <span class="p">=</span> <span class="n">executionQueue</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">l</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
  <span class="n">executionQueue</span><span class="p">.</span><span class="n">Dequeue</span><span class="p">()();</span>
<span class="p">}</span>
</pre></div>


<p>&nbsp;&nbsp; 3. Enqueue any code which uses a <code>UnityEngine</code> API.</p>
<div class="codehilite"><pre><span></span><span class="n">client</span><span class="p">.</span><span class="n">Connect</span><span class="p">(</span><span class="n">_session</span><span class="p">,</span> <span class="p">(</span><span class="kt">bool</span> <span class="n">done</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="n">executionQueue</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Session connected.&quot;</span><span class="p">);</span>
    <span class="c1">// Store session for quick reconnects.</span>
    <span class="n">PlayerPrefs</span><span class="p">.</span><span class="n">SetString</span><span class="p">(</span><span class="s">&quot;nk.session&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span> <span class="c1">// a UnityEngine API</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>


<p>You can see a more advanced version of this pattern in the <a href="#full-example">full example</a>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>This code pattern is not specific to our client. It's useful for any code which executes on a separate thread with Unity engine.</p>
</div>
<h3 id="managed-client">Managed client<a class="headerlink" href="#managed-client" title="Permanent link">&para;</a></h3>
<p>If you don't care about explicit control over which callbacks are dispatched on the Unity main thread you can wrap your code in a helper class which will handle it for you. The <code>"NManagedClient"</code> acts as a proxy for all callbacks.</p>
<p>You must call <code>.ExecuteActions()</code> in <code>Update</code> with the managed client or no callbacks will ever be run.</p>
<div class="codehilite"><pre><span></span><span class="k">using</span> <span class="nn">Nakama</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">NakamaSessionManager</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
  <span class="k">private</span> <span class="n">INClient</span> <span class="n">_client</span><span class="p">;</span>

  <span class="k">public</span> <span class="nf">NakamaSessionManager</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="n">NClient</span><span class="p">.</span><span class="n">Default</span><span class="p">(</span><span class="s">&quot;defaultkey&quot;</span><span class="p">);</span>
    <span class="n">_client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NManagedClient</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span> <span class="p">{</span>
<span class="hll">    <span class="p">(</span><span class="n">_client</span> <span class="k">as</span> <span class="n">NManagedClient</span><span class="p">).</span><span class="n">ExecuteActions</span><span class="p">();</span> <span class="c1">// important!</span>
</span>  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>This makes code simpler to reason about but is slightly less performant than if you control exactly which callbacks use UnityEngine APIs and "move them" onto the main thread with an action queue.</p>
<h2 id="logs-and-errors">Logs and errors<a class="headerlink" href="#logs-and-errors" title="Permanent link">&para;</a></h2>
<p>The <a href="../install-configuration/#log">server</a> and the client can generate logs which are helpful to debug code. To log all messages sent by the client you can enable "Trace" when you build an <code>"INClient"</code>.</p>
<div class="codehilite"><pre><span></span><span class="cp">#if UNITY_EDITOR</span>
<span class="n">INClient</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NClient</span><span class="p">.</span><span class="n">Builder</span><span class="p">(</span><span class="s">&quot;defaultkey&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Trace</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Build</span><span class="p">();</span>
<span class="cp">#else</span>
<span class="n">INClient</span> <span class="n">client</span> <span class="p">=</span> <span class="n">NClient</span><span class="p">.</span><span class="n">Default</span><span class="p">(</span><span class="s">&quot;defaultkey&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
</pre></div>


<p>The <code>#if</code> preprocessor directives is used so trace is only enabled in Unity editor builds. For more complex directives with debug vs release builds have a look at <a href="https://docs.unity3d.com/Manual/PlatformDependentCompilation.html" target="\_blank">Platform dependent compilation</a>.</p>
<p>Every error in the Unity client implements the <code>"INError"</code> interface. It contains details on the source and content of an error:</p>
<div class="codehilite"><pre><span></span><span class="n">Action</span><span class="p">&lt;</span><span class="n">INError</span><span class="p">&gt;</span> <span class="n">errorHandler</span> <span class="p">=</span> <span class="k">delegate</span><span class="p">(</span><span class="n">INError</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Debug</span><span class="p">.</span><span class="n">LogFormat</span><span class="p">(</span><span class="s">&quot;Error code {0}&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">Code</span><span class="p">);</span>
  <span class="n">Debug</span><span class="p">.</span><span class="n">LogFormat</span><span class="p">(</span><span class="s">&quot;Error message {0}&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>


<hr />
<h2 id="full-example">Full example<a class="headerlink" href="#full-example" title="Permanent link">&para;</a></h2>
<p>An example class used to manage a session with the Unity client.</p>
<div class="codehilite"><pre><span></span><span class="k">using</span> <span class="nn">Nakama</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">NakamaSessionManager</span> <span class="p">:</span> <span class="n">MonoBehaviour</span> <span class="p">{</span>
  <span class="k">private</span> <span class="n">INClient</span> <span class="n">_client</span><span class="p">;</span>
  <span class="k">private</span> <span class="n">INSession</span> <span class="n">_session</span><span class="p">;</span>

  <span class="k">private</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">IEnumerator</span><span class="p">&gt;</span> <span class="n">_executionQueue</span><span class="p">;</span>

  <span class="k">public</span> <span class="nf">NakamaSessionManager</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">_client</span> <span class="p">=</span> <span class="n">NClient</span><span class="p">.</span><span class="n">Default</span><span class="p">(</span><span class="s">&quot;defaultkey&quot;</span><span class="p">);</span>
    <span class="n">_executionQueue</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">IEnumerator</span><span class="p">&gt;(</span><span class="m">1024</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">void</span> <span class="nf">Awake</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">RestoreSessionAndConnect</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_session</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">LoginOrRegister</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">void</span> <span class="nf">RestoreSessionAndConnect</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Lets check if we can restore a cached session.</span>
    <span class="kt">var</span> <span class="n">sessionString</span> <span class="p">=</span> <span class="n">PlayerPrefs</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">&quot;nk.session&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">sessionString</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span> <span class="c1">// We have no session to restore.</span>
    <span class="p">}</span>

    <span class="kt">var</span> <span class="n">session</span> <span class="p">=</span> <span class="n">NSession</span><span class="p">.</span><span class="n">Restore</span><span class="p">(</span><span class="n">sessionString</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="p">.</span><span class="n">HasExpired</span><span class="p">(</span><span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span> <span class="c1">// We can&#39;t restore an expired session.</span>
    <span class="p">}</span>

    <span class="n">SessionHandler</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">void</span> <span class="nf">LoginOrRegister</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// See if we have a cached id in PlayerPrefs.</span>
    <span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="n">PlayerPrefs</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">&quot;nk.id&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// We&#39;ll use device ID for the user. See other authentication options.</span>
      <span class="n">id</span> <span class="p">=</span> <span class="n">SystemInfo</span><span class="p">.</span><span class="n">deviceUniqueIdentifier</span><span class="p">;</span>
      <span class="c1">// Store the identifier for next game start.</span>
      <span class="n">PlayerPrefs</span><span class="p">.</span><span class="n">SetString</span><span class="p">(</span><span class="s">&quot;nk.id&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Use whichever one of the authentication options you want.</span>
    <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="n">NAuthenticateMessage</span><span class="p">.</span><span class="n">Device</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
    <span class="n">_client</span><span class="p">.</span><span class="n">Login</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">SessionHandler</span><span class="p">,</span> <span class="p">(</span><span class="n">INError</span> <span class="n">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">.</span><span class="n">Code</span> <span class="p">==</span> <span class="n">ErrorCode</span><span class="p">.</span><span class="n">UserNotFound</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_client</span><span class="p">.</span><span class="n">Register</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">SessionHandler</span><span class="p">,</span> <span class="n">ErrorHandler</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">ErrorHandler</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">void</span> <span class="nf">SessionHandler</span><span class="p">(</span><span class="n">INSession</span> <span class="n">session</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_session</span> <span class="p">=</span> <span class="n">session</span><span class="p">;</span>
    <span class="n">Debug</span><span class="p">.</span><span class="n">LogFormat</span><span class="p">(</span><span class="s">&quot;Session: &#39;{0}&#39;.&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>
    <span class="n">_client</span><span class="p">.</span><span class="n">Connect</span><span class="p">(</span><span class="n">_session</span><span class="p">,</span> <span class="p">(</span><span class="kt">bool</span> <span class="n">done</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="c1">// We enqueue callbacks which contain code which must be dispatched on</span>
      <span class="c1">// the Unity main thread.</span>
      <span class="n">Enqueue</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Session connected.&quot;</span><span class="p">);</span>
        <span class="c1">// Store session for quick reconnects.</span>
        <span class="n">PlayerPrefs</span><span class="p">.</span><span class="n">SetString</span><span class="p">(</span><span class="s">&quot;nk.session&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">lock</span> <span class="p">(</span><span class="n">_executionQueue</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">len</span> <span class="p">=</span> <span class="n">_executionQueue</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
        <span class="n">StartCoroutine</span><span class="p">(</span><span class="n">_executionQueue</span><span class="p">.</span><span class="n">Dequeue</span><span class="p">());</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">void</span> <span class="nf">OnApplicationQuit</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_session</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_client</span><span class="p">.</span><span class="n">Disconnect</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">void</span> <span class="nf">Enqueue</span><span class="p">(</span><span class="n">Action</span> <span class="n">action</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">lock</span> <span class="p">(</span><span class="n">_executionQueue</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">_executionQueue</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="n">ActionWrapper</span><span class="p">(</span><span class="n">action</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">_executionQueue</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">1024</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Debug</span><span class="p">.</span><span class="n">LogWarning</span><span class="p">(</span><span class="s">&quot;Queued actions not consumed fast enough.&quot;</span><span class="p">);</span>
        <span class="n">_client</span><span class="p">.</span><span class="n">Disconnect</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="n">IEnumerator</span> <span class="nf">ActionWrapper</span><span class="p">(</span><span class="n">Action</span> <span class="n">action</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">action</span><span class="p">();</span>
    <span class="k">yield</span> <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ErrorHandler</span><span class="p">(</span><span class="n">INError</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Debug</span><span class="p">.</span><span class="n">LogErrorFormat</span><span class="p">(</span><span class="s">&quot;Error: code &#39;{0}&#39; with &#39;{1}&#39;.&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="n">Code</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../install-nakama-upgrade/" title="Upgrades" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Upgrades
              </span>
            </div>
          </a>
        
        
          <a href="../android-java-client-guide/" title="Android client guide" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Android client guide
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2017 Heroic Labs
          </div>
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://heroiclabs.com" class="md-footer-social__link fa fa-globe"></a>
    
      <a href="https://github.com/heroiclabs" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/heroicdev" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/company/heroic-labs" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application-c35428f87f.js"></script>
      
      
      <script>app.initialize({url:{base:".."}})</script>
      
        <script src="../js/main.js"></script>
      
    
    
      
    
  </body>
</html>