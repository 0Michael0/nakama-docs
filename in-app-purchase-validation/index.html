
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Documentation for the Nakama realtime and social server for games and apps.">
      
      
        <link rel="canonical" href="https://heroiclabs.com/docs/in-app-purchase-validation/">
      
      
        <meta name="author" content="Heroic Labs Team & contributors">
      
      
        <link rel="shortcut icon" href="../images/favicon.ico">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.7.4">
    
    
      
        <title>In-app Purchase Validation - Nakama server</title>
      
    
    
      <script src="../assets/javascripts/modernizr-1df76c4e58.js"></script>
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application-769c285a91.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-02c2a4388f.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="https://heroiclabs.com/docs/" title="Nakama server" class="md-logo md-header-nav__button">
            <img src="../images/logo-white.svg" width="24" height="24">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
            
            In-app Purchase Validation
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">close</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/heroiclabs/nakama" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      heroiclabs/nakama
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-logo md-nav__button">
        <img src="../images/logo-white.svg">
      </i>
    
    Nakama server
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/heroiclabs/nakama" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      heroiclabs/nakama
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Install and setup
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Install and setup
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../install-docker-quickstart/" title="Docker quickstart" class="md-nav__link">
      Docker quickstart
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install-binary/" title="Binary install" class="md-nav__link">
      Binary install
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Storage Engine
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Storage Engine
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../storage-collections/" title="Collections" class="md-nav__link">
      Collections
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Social API
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Social API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../friends/" title="Friends" class="md-nav__link">
      Friends
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../groups-clans/" title="Groups and Clans" class="md-nav__link">
      Groups and Clans
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../in-app-notifications/" title="In-app Notifications" class="md-nav__link">
      In-app Notifications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../realtime-chat/" title="Realtime Chat" class="md-nav__link">
      Realtime Chat
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        In-app Purchase Validation
      </label>
    
    <a href="./" title="In-app Purchase Validation" class="md-nav__link md-nav__link--active">
      In-app Purchase Validation
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#apple" title="Apple" class="md-nav__link">
    Apple
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup" title="Setup" class="md-nav__link">
    Setup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validate-purchase" title="Validate Purchase" class="md-nav__link">
    Validate Purchase
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#google" title="Google" class="md-nav__link">
    Google
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup_1" title="Setup" class="md-nav__link">
    Setup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validate-purchase_1" title="Validate Purchase" class="md-nav__link">
    Validate Purchase
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interpreting-responses" title="Interpreting Responses" class="md-nav__link">
    Interpreting Responses
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recovering-purchases" title="Recovering Purchases" class="md-nav__link">
    Recovering Purchases
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Runtime Code
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Runtime Code
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../runtime-function-reference/" title="Function Reference" class="md-nav__link">
      Function Reference
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Tutorials
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Tutorials
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../tutorials/initialize-new-user/" title="Initialize a new user" class="md-nav__link">
      Initialize a new user
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tutorials/remote-configuration/" title="Remote configuration" class="md-nav__link">
      Remote configuration
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#apple" title="Apple" class="md-nav__link">
    Apple
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup" title="Setup" class="md-nav__link">
    Setup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validate-purchase" title="Validate Purchase" class="md-nav__link">
    Validate Purchase
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#google" title="Google" class="md-nav__link">
    Google
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup_1" title="Setup" class="md-nav__link">
    Setup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validate-purchase_1" title="Validate Purchase" class="md-nav__link">
    Validate Purchase
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#interpreting-responses" title="Interpreting Responses" class="md-nav__link">
    Interpreting Responses
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recovering-purchases" title="Recovering Purchases" class="md-nav__link">
    Recovering Purchases
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="in-app-purchase-validation">In-app Purchase Validation</h1>
<p>The spectrum of monetisation models and tools is extremely varied. From ad-supported, microtransactions, freemium, one-off purchases, and everything in between. A key tool in many of these solutions is the In-App Purchase, which enables single purchases for unlocks, in-game consumables, subscriptions for premium access, and more.</p>
<p>There are a number of readily available attacks against the most common in-app purchase implementations.</p>
<p>These are usually focused around:</p>
<ul>
<li>Feeding the client fake purchase responses which indicate success.</li>
<li>Replaying a valid purchase response multiple times.</li>
<li>Sharing a purchase response with another client, so multiple players can receive the reward from a single purchase.</li>
<li>...and more, with new vulnerabilities emerging occasionally.</li>
</ul>
<p>For in-app purchases, a trusted source of truth is required. Nakama checks and tracks purchases and purchase history, solving a significant set of possible vulnerabilities and pain points.</p>
<p>In-App Purchase Validation is available for Apple and Google purchases, regardless of platform. Both single product and subscription purchases are supported.</p>
<p><strong>Fake Purchases</strong></p>
<p>Nakama directly connects to Apple and Google services to check the validity of all incoming payments. This verification is completely outside the client's code, and cannot be intercepted and tampered with.</p>
<p>Every transaction is verified, every time, and invalid ones are rejected.</p>
<p><strong>Replay Attacks</strong></p>
<p>All transactions are logged, preventing multiple submissions of the same purchase token or receipt.</p>
<p><strong>Receipt Sharing</strong></p>
<p>Successful transactions are bound to the account that submits them. Different users cannot submit the same transaction, even a valid one, in an attempt to receive the associated reward.</p>
<p><strong>Product Mismatches</strong></p>
<p>The transaction is checked to ensure the correct reward is tied to each purchase. This prevents attacks that attempt to use a valid (cheap) purchase to unlock a different (expensive) reward.</p>
<p><strong>Subscription Expiry</strong></p>
<p>Nakama checks subscriptions to see if they've expired, and rejects the transaction as needed.</p>
<p><strong>Purchase Cancellation</strong></p>
<p>Valid receipts that link to cancelled purchases are flagged and rejected.</p>
<p><strong>Single Source of Truth</strong></p>
<p>While Nakama maintains an internal record of all transactions, the remote payment provider is always given priority. Valid purchases that have been checked, logged, then subsequently cancelled, will be rejected appropriately.</p>
<h2 id="apple">Apple</h2>
<p>Nakama supports validating purchases made for products and subscription in iOS.</p>
<p>Apple purchase receipts are sent to Apple for validation. As suggested by Apple, both Production and Sandbox servers are used to validate receipts depending on the priority setup in the Nakama configuration.</p>
<h3 id="setup">Setup</h3>
<p>To validate receipts against the App Store, Nakama requires your app's shared secret. You can setup a shared secret in <a href="https://itunesconnect.apple.com">iTunes Connect</a>.</p>
<p><img alt="Apple iTunes Connect" src="../images/apple_iap_1.jpg" title="Apple iTunes Connect" /></p>
<p>Make a record of your shared secret:</p>
<p><img alt="Apple iTunes Connect Shared Secret" src="../images/apple_iap_2.jpg" title="Apple iTunes Connect Shared Secret" /></p>
<p>You'll need to set the value of <code>purchase.apple.password</code> to the value of the Shared Secret above. For more info, take a look at the <a href="configuration.md#purchase">configuration</a> page.</p>
<p>If your app is in production, you'll need to set the value of <code>purchase.apple.production</code> to true to give priority Apple's Production servers.</p>
<h3 id="validate-purchase">Validate Purchase</h3>
<p>Nakama only supports validating iOS 7+ receipts. In addition, Nakama only validates the first item in the receipt as Apple receipts can contain more than one in-app purchase item.</p>
<div class="codehilite"><pre><span></span><span class="kt">var</span> <span class="n">productId</span> <span class="p">=</span> <span class="s">&quot;com.yourcompany.product&quot;</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">receiptData</span> <span class="p">=</span> <span class="s">&quot;...some-base64-encoded-data...&quot;</span><span class="p">;</span>

<span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="n">NPurchaseValidateMessage</span><span class="p">.</span><span class="n">Apple</span><span class="p">(</span><span class="n">productId</span><span class="p">,</span> <span class="n">receiptData</span><span class="p">);</span>
<span class="n">client</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="p">(</span><span class="n">INPurchaseRecord</span> <span class="n">record</span><span class="p">)</span> <span class="p">=&gt;</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(!</span><span class="n">record</span><span class="p">.</span><span class="n">Success</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Purchase was not validation. Reason: {0}.&quot;</span><span class="p">,</span> <span class="n">record</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="n">SeenBefore</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// This is useful for recovering previous purchases</span>
      <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;This is a valid purchase but the purchase item was redeemed once before.&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;New purchase was validated&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">},</span> <span class="p">(</span><span class="n">INError</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="n">Debug</span><span class="p">.</span><span class="n">LogErrorFormat</span><span class="p">(</span><span class="s">&quot;Error: code &#39;{0}&#39; with &#39;{1}&#39;.&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="n">Code</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>


<table>
<thead>
<tr>
<th>Param</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>receipt_data</td>
<td>string</td>
<td>Base-64 encoded receipt data returned by the purchase operation itself.</td>
</tr>
<tr>
<td>product_id</td>
<td>string</td>
<td>The product, item, or subscription package ID the purchase relates to.</td>
</tr>
</tbody>
</table>
<h2 id="google">Google</h2>
<p>Nakama supports validating purchases made for products and subscription on Android.</p>
<h3 id="setup_1">Setup</h3>
<p>To validate receipts against the Play Store, Nakama requires your app's package name, as well as a service file. You can setup a service account and download the service file on <a href="https://play.google.com/apps/publish">Google Play Developer Console</a>.</p>
<p>Firstly, you'll need to setup a Service Account in the <a href="https://console.developers.google.com/iam-admin/serviceaccounts/">Google API Console</a>.</p>
<p><img alt="Create Service Account" src="../images/google_iap_1_create_service_account.jpg" title="Create Service Account" /></p>
<p>Once a service account is created, you'll need to create a key:</p>
<p><img alt="Create Key" src="../images/google_iap_2_create_key.jpg" title="Create Key" /></p>
<p>Download the key as a JSON file. You'll need to put this file somewhere that Nakama server can access.</p>
<p><img alt="Create Key" src="../images/google_iap_3_create_key_2.jpg" title="Create Key" /></p>
<p>Once the key is created, navigate back to <a href="https://play.google.com/apps/publish">Google Play Developer Console</a> and navigate to <strong>Settings</strong> &gt; <strong>API Access</strong>.</p>
<p>The service account you created in the previous steps should be listed above. You'll need to grant access to the service account to access the API:</p>
<p><img alt="Create API Access" src="../images/google_iap_5_play_api.jpg" title="Create API Access" /></p>
<p>Make sure that you give the service account access to <strong>Visibility</strong>, <strong>View Financial Data</strong>, and <strong>Manage Orders</strong>. These permissions are required for Nakama to validate receipts against Google Play.</p>
<p><img alt="Grand Access" src="../images/google_iap_6_grant_access.jpg" title="Grand Access" /></p>
<p>Navigate to <strong>Users &amp; Permissions</strong> to check that the service account is setup correctly.</p>
<p><img alt="List users with access" src="../images/google_iap_7_play_users.jpg" title="List users with access" /></p>
<p>Lastly, you'll need to update Nakama's configuration with the following information:</p>
<ul>
<li>
<p><code>purchase.google.package_name</code>: Package name for your Android app, as you've listed in Google Play.</p>
</li>
<li>
<p><code>purchase.google.service_key_file</code>: Path of the JSON file you download in previous steps. This file contains authentication information that allows Nakama to communicate with Google Play on your behalf. Make sure that the file is kept safe and is only accessible by Nakama and other authorized parties.</p>
</li>
</ul>
<h3 id="validate-purchase_1">Validate Purchase</h3>
<div class="codehilite"><pre><span></span><span class="kt">var</span> <span class="n">productId</span> <span class="p">=</span> <span class="s">&quot;com.yourcompany.product&quot;</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">purchaseType</span> <span class="p">=</span> <span class="s">&quot;product&quot;</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">purchaseToken</span> <span class="p">=</span> <span class="s">&quot;some-token-from-google&quot;</span><span class="p">;</span>

<span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="n">NPurchaseValidateMessage</span><span class="p">.</span><span class="n">Google</span><span class="p">(</span><span class="n">productId</span><span class="p">,</span> <span class="n">purchaseType</span><span class="p">,</span> <span class="n">purchaseToken</span><span class="p">);</span>
<span class="n">client</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="p">(</span><span class="n">INPurchaseRecord</span> <span class="n">record</span><span class="p">)</span> <span class="p">=&gt;</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(!</span><span class="n">record</span><span class="p">.</span><span class="n">Success</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Purchase was not validation. Reason: {0}.&quot;</span><span class="p">,</span> <span class="n">record</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="n">SeenBefore</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// This is useful for recovering previous purchases</span>
      <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;This is a valid purchase but the purchase item was redeemed once before.&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;New purchase was validated&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">},</span> <span class="p">(</span><span class="n">INError</span> <span class="n">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="n">Debug</span><span class="p">.</span><span class="n">LogErrorFormat</span><span class="p">(</span><span class="s">&quot;Error: code &#39;{0}&#39; with &#39;{1}&#39;.&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="n">Code</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>


<table>
<thead>
<tr>
<th>Param</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>product_type</td>
<td>string</td>
<td>Whether the purchase is for a <code>product</code> or a <code>subscription</code></td>
</tr>
<tr>
<td>purchase_token</td>
<td>string</td>
<td>The token returned in the purchase operation response, acts as a transaction identifier.</td>
</tr>
<tr>
<td>product_id</td>
<td>string</td>
<td>The identifier of the product or subscription being purchased.</td>
</tr>
</tbody>
</table>
<h2 id="interpreting-responses">Interpreting Responses</h2>
<p>Responses contain the following information:</p>
<ul>
<li><code>success</code> - Whether or not the transaction is valid and all the information matches.</li>
<li><code>seen_before</code> - If this is a new transaction or if Nakama has a log of it.</li>
<li><code>purchase_provider_reachable</code> - Indicates whether or not Nakama was able to reach the remote purchase service.</li>
<li><code>message</code> - A string indicating why the purchase verification failed, if appropriate.</li>
<li><code>data</code> - The complete response Nakama received from the remote service.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If <code>purchase_provider_reachable</code> is <code>false</code> it indicates that Nakama was unable to query the remote purchase service. In this situation the client should use its discretion to decide if the purchase should be accepted, and must queue up the verification request for a later retry.</p>
</div>
<p>Each response contains all the information needed to take the appropriate action. Below is a quick reference for interpreting the key fields:</p>
<table>
<thead>
<tr>
<th><code></code></th>
<th><code>seen_before</code> = <code>true</code></th>
<th><code>seen_before</code> = <code>false</code></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>success</code> = <code>true</code></td>
<td><mark>Valid, but Nakama has an existing record of it.</mark></td>
<td>Valid and new.</td>
<td></td>
</tr>
<tr>
<td><code>success</code> = <code>false</code></td>
<td><mark style="background-color: pink"> Rejected, check <code>message</code> field for reason.</mark></td>
<td><mark style="background-color: pink">Rejected, check <code>message</code> field for reason.</mark></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="recovering-purchases">Recovering Purchases</h2>
<p>When users change devices, it's common to offer an option (or fully automated process) to re-apply the benefits of any previous purchases to their new client installation.</p>
<p>Clients should always refer to the platform purchase provider for a list of purchases, then verify each one with Nakama. In this case clients should accommodate responses where the <code>seen_before</code> indicator is true and act accordingly.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../realtime-chat/" title="Realtime Chat" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Realtime Chat
              </span>
            </div>
          </a>
        
        
          <a href="../runtime-function-reference/" title="Function Reference" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Function Reference
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2017 Heroic Labs
          </div>
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://heroiclabs.com" class="md-footer-social__link fa fa-globe"></a>
    
      <a href="https://github.com/heroiclabs" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/heroicdev" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/company/heroic-labs" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application-c35428f87f.js"></script>
      
      
      <script>app.initialize({url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>