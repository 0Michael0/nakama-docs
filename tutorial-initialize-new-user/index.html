



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Documentation for the Nakama realtime and social server for games and apps.">
      
      
        <link rel="canonical" href="https://heroiclabs.com/tutorial-initialize-new-user/">
      
      
        <meta name="author" content="Heroic Labs Team & contributors">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../images/favicon.ico">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.2.0">
    
    
      
        <title>Initialize a new user - Nakama server</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.5d3fffba.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.fbd935c7.css">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../stylesheets/code-tabs.css">
    
    
  </head>
  
    
    
    
      <body data-md-color-primary="indigo" data-md-color-accent="indigo">
    
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://heroiclabs.com/" title="Nakama server" class="md-header-nav__button md-logo">
          
            <img src="../images/logo-white.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Nakama server
              </span>
              <span class="md-header-nav__topic">
                Initialize a new user
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/heroiclabs/nakama/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      heroiclabs/nakama
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <img src="../images/logo-white.svg" width="24" height="24">
      
    </span>
    Nakama server
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/heroiclabs/nakama/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      heroiclabs/nakama
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../nakama-download/" title="Download" class="md-nav__link">
      Download
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Install and setup
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Install and setup
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../install-docker-quickstart/" title="Docker quickstart" class="md-nav__link">
      Docker quickstart
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install-binary/" title="Binary install" class="md-nav__link">
      Binary install
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install-configuration/" title="Configuration" class="md-nav__link">
      Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install-server-cli/" title="Nakama CLI" class="md-nav__link">
      Nakama CLI
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install-nakama-upgrade/" title="Upgrades" class="md-nav__link">
      Upgrades
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../unity-client-guide/" title="Unity client guide" class="md-nav__link">
      Unity client guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../android-java-client-guide/" title="Android client guide" class="md-nav__link">
      Android client guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../javascript-client-guide/" title="JavaScript client guide" class="md-nav__link">
      JavaScript client guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../swift-ios-client-guide/" title="Swift/iOS client guide" class="md-nav__link">
      Swift/iOS client guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../authentication/" title="Authentication" class="md-nav__link">
      Authentication
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../user-accounts/" title="User accounts" class="md-nav__link">
      User accounts
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Storage Engine
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        Storage Engine
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../storage-collections/" title="Collections" class="md-nav__link">
      Collections
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11">
    
    <label class="md-nav__link" for="nav-11">
      Social
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        Social
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../social-friends/" title="Friends" class="md-nav__link">
      Friends
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../social-groups-clans/" title="Groups and Clans" class="md-nav__link">
      Groups and Clans
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../social-in-app-notifications/" title="In-app Notifications" class="md-nav__link">
      In-app Notifications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../social-realtime-chat/" title="Realtime Chat" class="md-nav__link">
      Realtime Chat
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-12" type="checkbox" id="nav-12">
    
    <label class="md-nav__link" for="nav-12">
      Gameplay
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-12">
        Gameplay
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../gameplay-leaderboards/" title="Leaderboards" class="md-nav__link">
      Leaderboards
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../gameplay-matchmaker/" title="Matchmaker" class="md-nav__link">
      Matchmaker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../gameplay-multiplayer-realtime/" title="Realtime Multiplayer" class="md-nav__link">
      Realtime Multiplayer
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../in-app-purchase-validation/" title="In-app Purchase Validation" class="md-nav__link">
      In-app Purchase Validation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-14" type="checkbox" id="nav-14">
    
    <label class="md-nav__link" for="nav-14">
      Runtime Code
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-14">
        Runtime Code
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../runtime-code-basics/" title="Basics" class="md-nav__link">
      Basics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../runtime-code-function-reference/" title="Function Reference" class="md-nav__link">
      Function Reference
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../benchmarks/" title="Benchmarks" class="md-nav__link">
      Benchmarks
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-16" type="checkbox" id="nav-16">
    
    <label class="md-nav__link" for="nav-16">
      Deployment
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-16">
        Deployment
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../deployment-digital-ocean/" title="Digital Ocean" class="md-nav__link">
      Digital Ocean
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-17" type="checkbox" id="nav-17" checked>
    
    <label class="md-nav__link" for="nav-17">
      Tutorials
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-17">
        Tutorials
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../tutorial-develop-with-libgdx/" title="Develop with LibGDX" class="md-nav__link">
      Develop with LibGDX
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Initialize a new user
      </label>
    
    <a href="./" title="Initialize a new user" class="md-nav__link md-nav__link--active">
      Initialize a new user
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#after-register-callback" title="After register callback" class="md-nav__link">
    After register callback
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server-side-hook" title="Server-side hook" class="md-nav__link">
    Server-side hook
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialize-record-when-used" title="Initialize record when used" class="md-nav__link">
    Initialize record when used
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tutorial-remote-configuration/" title="Remote configuration" class="md-nav__link">
      Remote configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../tutorial-send-push-messages/" title="Send push messages" class="md-nav__link">
      Send push messages
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#after-register-callback" title="After register callback" class="md-nav__link">
    After register callback
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server-side-hook" title="Server-side hook" class="md-nav__link">
    Server-side hook
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialize-record-when-used" title="Initialize record when used" class="md-nav__link">
    Initialize record when used
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/heroiclabs/nakama-docs/edit/master/docs/tutorial-initialize-new-user.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="initialize-a-new-user">Initialize a new user<a class="headerlink" href="#initialize-a-new-user" title="Permanent link">&para;</a></h1>
<p>It's often useful when a new user registers to have a bunch of records setup for them. In games this could be needed for a user's virtual wallet, initial inventory items, etc. In this tutorial we'll cover a few different ways to handle this use case.</p>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>While there are various ways to solve this use case we highly recommend you <a href="#initialize-record-when-used">initialize the records on usage</a>.</p>
</div>
<h2 id="after-register-callback">After register callback<a class="headerlink" href="#after-register-callback" title="Permanent link">&para;</a></h2>
<p>The simplest approach is to write records in the success callback for the register function in a client.</p>
<p>This code demonstrates how to do it with a condensed example. In real application code you'll break up the <a href="../authentication/">authentication</a> and connect logic from the storage writes based on how you manage connect and reconnect.</p>
<div class="codehilite"><pre><span></span><span class="kt">var</span> <span class="n">errorHandler</span> <span class="p">=</span> <span class="k">delegate</span><span class="p">(</span><span class="n">INError</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Debug</span><span class="p">.</span><span class="n">LogErrorFormat</span><span class="p">(</span><span class="s">&quot;Error: code &#39;{0}&#39; with &#39;{1}&#39;.&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="n">Code</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
<span class="p">};</span>

<span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="n">SystemInfo</span><span class="p">.</span><span class="n">deviceUniqueIdentifier</span><span class="p">;</span>
<span class="c1">// Use one of the user register messages.</span>
<span class="kt">var</span> <span class="n">authMessage</span> <span class="p">=</span> <span class="n">NAuthenticateMessage</span><span class="p">.</span><span class="n">Device</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="n">client</span><span class="p">.</span><span class="n">Register</span><span class="p">(</span><span class="n">authMessage</span><span class="p">,</span> <span class="p">(</span><span class="n">INSession</span> <span class="n">session</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="n">client</span><span class="p">.</span><span class="n">Connect</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="p">(</span><span class="kt">bool</span> <span class="n">done</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kt">var</span> <span class="n">json</span> <span class="p">=</span> <span class="s">&quot;{\&quot;coins\&quot;: 100, \&quot;gems\&quot;: 10, \&quot;artifacts\&quot;: 0}&quot;</span><span class="p">;</span>

    <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NStorageWriteMessage</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
        <span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&quot;mygame&quot;</span><span class="p">,</span> <span class="s">&quot;wallets&quot;</span><span class="p">,</span> <span class="s">&quot;mywallet&quot;</span><span class="p">,</span> <span class="n">json</span><span class="p">)</span>
        <span class="p">.</span><span class="n">Build</span><span class="p">();</span>
    <span class="n">client</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="p">(</span><span class="n">INResultSet</span><span class="p">&lt;</span><span class="n">INStorageKey</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Successfully setup new user&#39;s records.&quot;</span><span class="p">);</span>
    <span class="p">},</span> <span class="n">errorHandler</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">},</span> <span class="n">errorHandler</span><span class="p">);</span>
</pre></div>


<p>This code has tradeoffs which should be noted. A disconnect can happen before the records are written to storage. This may leave the setup of the user incomplete and the application in a bad state.</p>
<p>This option is only worth choosing when you want to avoid writing server-side code or have built retry logic on top of a client.</p>
<h2 id="server-side-hook">Server-side hook<a class="headerlink" href="#server-side-hook" title="Permanent link">&para;</a></h2>
<p>Another way to write records for the new user is to run server-side code after registration has completed. This can be done with a <a href="../runtime-code-basics/#register-hooks">register hook</a>.</p>
<p>The <a href="../runtime-code-function-reference/#register-hooks">"register_after"</a> hook can be used with one of the <code>"authenticaterequest_*"</code> message types to tell the server to run a function after that message has been processed. It's important to note that the server does not distinguish between register and login messages so we use a <a href="../storage-collections/#conditional-writes">conditional write</a> to store the records.</p>
<div class="codehilite"><pre><span></span><span class="kd">local</span> <span class="n">nk</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;nakama&quot;</span><span class="p">)</span>

<span class="kd">local</span> <span class="kr">function</span> <span class="nf">initialize_user</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">_payload</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">value</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">coins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">gems</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">artifacts</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="p">}</span>
  <span class="kd">local</span> <span class="n">record</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">Bucket</span> <span class="o">=</span> <span class="s2">&quot;mygame&quot;</span><span class="p">,</span>
    <span class="n">Collection</span> <span class="o">=</span> <span class="s2">&quot;wallets&quot;</span><span class="p">,</span>
    <span class="n">Record</span> <span class="o">=</span> <span class="s2">&quot;mywallet&quot;</span><span class="p">,</span>
    <span class="n">UserId</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">UserId</span><span class="p">,</span>
    <span class="n">Value</span> <span class="o">=</span> <span class="n">value</span><span class="p">,</span>
    <span class="n">Version</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>   <span class="c1">-- only write record if one doesn&#39;t already exist.</span>
  <span class="p">}</span>
  <span class="nb">pcall</span><span class="p">(</span><span class="n">nk</span><span class="p">.</span><span class="n">storage_write</span><span class="p">,</span> <span class="p">{</span> <span class="n">record</span> <span class="p">})</span> <span class="c1">-- write record, ignore errors.</span>
<span class="kr">end</span>

<span class="c1">-- change to whatever message name matches your authentication type.</span>
<span class="n">nk</span><span class="p">.</span><span class="n">register_after</span><span class="p">(</span><span class="n">initialize_user</span><span class="p">,</span> <span class="s2">&quot;authenticaterequest_device&quot;</span><span class="p">)</span>
</pre></div>


<p>This approach avoids the tradeoff with client disconnects but requires a database write to happen after every login or register message. This could be acceptable depending on how frequently you write data to the storage engine and can be minimized if you <a href="../authentication/#sessions">cache a user's session</a> for quick reconnects.</p>
<h2 id="initialize-record-when-used">Initialize record when used<a class="headerlink" href="#initialize-record-when-used" title="Permanent link">&para;</a></h2>
<p>The last way to write initial records for the user is to <code>"init"</code> the record with a storage update wherever it's written to in application code. With this approach you never use storage writes and always perform all write operations as updates.</p>
<p>In our example it means wherever you will update the "mywallet" record you ensure it's been initialized first.</p>
<div class="codehilite"><pre><span></span><span class="kt">var</span> <span class="n">json</span> <span class="p">=</span> <span class="s">&quot;{\&quot;coins\&quot;: 100, \&quot;gems\&quot;: 10, \&quot;artifacts\&quot;: 0}&quot;</span><span class="p">;</span>

<span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NStorageUpdateMessage</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="s">&quot;mygame&quot;</span><span class="p">,</span> <span class="s">&quot;wallets&quot;</span><span class="p">,</span> <span class="s">&quot;mywallet&quot;</span><span class="p">,</span> <span class="k">new</span> <span class="n">StorageUpdateBuilder</span><span class="p">()</span>
        <span class="c1">// make sure record is setup as</span>
        <span class="c1">//  {&quot;coins&quot;: 100, &quot;gems&quot;: 10, &quot;artifacts&quot;: 0}</span>
        <span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="s">&quot;/coins&quot;</span><span class="p">,</span> <span class="m">100</span><span class="p">)</span>
        <span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="s">&quot;/gems&quot;</span><span class="p">,</span> <span class="m">10</span><span class="p">)</span>
        <span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="s">&quot;/artifacts&quot;</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">.</span><span class="n">Incr</span><span class="p">(</span><span class="s">&quot;/coins&quot;</span><span class="p">,</span> <span class="p">-</span><span class="m">10</span><span class="p">)</span> <span class="c1">// perform other updates to the record.</span>
        <span class="p">.</span><span class="n">Build</span><span class="p">())</span>
    <span class="p">.</span><span class="n">Build</span><span class="p">();</span>
<span class="n">client</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="p">(</span><span class="n">INResultSet</span><span class="p">&lt;</span><span class="n">INStorageKey</span><span class="p">&gt;</span> <span class="n">list</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;Updated user&#39;s storage records.&quot;</span><span class="p">);</span>
<span class="p">},</span> <span class="p">(</span><span class="n">INError</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Debug</span><span class="p">.</span><span class="n">LogErrorFormat</span><span class="p">(</span><span class="s">&quot;Error: code &#39;{0}&#39; with &#39;{1}&#39;.&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="n">Code</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>


<p>You can also perform the "initialize before update" with server-side code.</p>
<div class="codehilite"><pre><span></span><span class="kd">local</span> <span class="n">nk</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;nakama&quot;</span><span class="p">)</span>

<span class="kd">local</span> <span class="n">value</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">coins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
  <span class="n">gems</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
  <span class="n">artifacts</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">}</span>
<span class="kd">local</span> <span class="n">update_ops</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">-- make sure record is setup as</span>
  <span class="c1">--  {&quot;coins&quot;: 100, &quot;gems&quot;: 10, &quot;artifacts&quot;: 0}</span>
  <span class="p">{</span> <span class="n">Op</span> <span class="o">=</span> <span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="n">Path</span> <span class="o">=</span> <span class="s2">&quot;/coins&quot;</span><span class="p">,</span> <span class="n">Value</span> <span class="o">=</span> <span class="mi">100</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">Op</span> <span class="o">=</span> <span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="n">Path</span> <span class="o">=</span> <span class="s2">&quot;/gems&quot;</span><span class="p">,</span> <span class="n">Value</span> <span class="o">=</span> <span class="mi">10</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">Op</span> <span class="o">=</span> <span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="n">Path</span> <span class="o">=</span> <span class="s2">&quot;/artifacts&quot;</span><span class="p">,</span> <span class="n">Value</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>

  <span class="c1">-- perform other updates to the record.</span>
  <span class="p">{</span> <span class="n">Op</span> <span class="o">=</span> <span class="s2">&quot;incr&quot;</span><span class="p">,</span> <span class="n">Path</span> <span class="o">=</span> <span class="s2">&quot;/coins&quot;</span><span class="p">,</span> <span class="n">Value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span> <span class="p">}</span>
<span class="p">}</span>
<span class="kd">local</span> <span class="n">record</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">Bucket</span> <span class="o">=</span> <span class="s2">&quot;mygame&quot;</span><span class="p">,</span>
  <span class="n">Collection</span> <span class="o">=</span> <span class="s2">&quot;wallets&quot;</span><span class="p">,</span>
  <span class="n">Record</span> <span class="o">=</span> <span class="s2">&quot;mywallet&quot;</span><span class="p">,</span>
  <span class="n">UserId</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">UserId</span><span class="p">,</span>
  <span class="n">Update</span> <span class="o">=</span> <span class="n">update_ops</span>
<span class="p">}</span>
<span class="n">nk</span><span class="p">.</span><span class="n">storage_update</span><span class="p">({</span> <span class="n">record</span> <span class="p">})</span>
</pre></div>


<p>This is our recommended approach. It has no tradeoffs compared with the other approaches except that you must remember to add <code>"init"</code> logic wherever the record would be updated.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../tutorial-develop-with-libgdx/" title="Develop with LibGDX" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Develop with LibGDX
              </span>
            </div>
          </a>
        
        
          <a href="../tutorial-remote-configuration/" title="Remote configuration" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Remote configuration
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2017 Heroic Labs
          </div>
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://heroiclabs.com" class="md-footer-social__link fa fa-globe"></a>
    
      <a href="https://github.com/heroiclabs" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/heroicdev" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://www.linkedin.com/company/heroic-labs" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.6cdc17f0.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:".."}})</script>
      
        <script src="../javascripts/main.js"></script>
      
    
    
      
    
  </body>
</html>